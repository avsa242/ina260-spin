CON

    XTAL        = cfg#XTAL
    XDIV        = cfg#XDIV
    XMUL        = cfg#XMUL
    XDIVP       = cfg#XDIVP
    XOSC        = cfg#XOSC
    XSEL        = cfg#XSEL
    XPPPP       = cfg#XPPPP
    CLOCKFREQ   = cfg#CLOCKFREQ
    SETFREQ     = cfg#SETFREQ
    ENAFREQ     = cfg#ENAFREQ

    LED         = cfg#LED1
    SER_RX      = cfg#SER_RX
    SER_TX      = cfg#SER_TX
    SER_BAUD    = 2_000_000

    I2C_SCL     = 27
    I2C_SDA     = 28
    I2C_HZ      = 400_000

OBJ

    ser         : "com.serial.terminal.ansi"
    cfg         : "core.con.boardcfg.p2eval"
    io          : "io"
    time        : "time"
    ina260      : "sensor.power.ina260.i2c.spin2"

VAR

    long _ser_cog, _ina260_cog

PUB Main

    Setup

    ser.position(0, 3)
    ser.printf("Mfr ID: %x, Die ID: %x\n", ina260.MfrID, ina260.DieID)
    FlashLED(LED, 100)     ' Signal execution finished

PUB Setup

    clkset(ENAFREQ, CLOCKFREQ, XSEL)
    repeat until _ser_cog := ser.StartRXTX (SER_RX, SER_TX, 0, SER_BAUD)
    ser.Clear
    ser.PrintF("Serial terminal started\n")
    if _ina260_cog := ina260.Start(I2C_SCL, I2C_SDA, I2C_HZ)
        ser.Printf("INA260 driver started\n")
    else
        ser.Printf("INA260 driver failed to start - halting\n")
        FlashLED(LED, 500)

PUB FlashLED(led_pin, delay_ms)

    io.Output(led_pin)
    repeat
        io.Toggle(led_pin)
        time.MSleep(delay_ms)

